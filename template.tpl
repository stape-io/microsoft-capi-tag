___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Microsoft Ads UET Conversion API",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "CONVERSIONS"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Tag that sends events to Microsoft Ads using the Microsoft UET Conversion API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "baseConfigGroup",
    "subParams": [
      {
        "type": "RADIO",
        "name": "eventTypeSetupMethod",
        "displayName": "Event Type Setup Method",
        "radioItems": [
          {
            "value": "standard",
            "displayValue": "Standard",
            "subParams": [
              {
                "type": "SELECT",
                "name": "eventType",
                "selectItems": [
                  {
                    "value": "pageLoad",
                    "displayValue": "Page Load"
                  },
                  {
                    "value": "custom",
                    "displayValue": "Custom"
                  }
                ],
                "simpleValueType": true,
                "displayName": "Event Type",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "alwaysInSummary": true,
                "subParams": []
              },
              {
                "type": "TEXT",
                "name": "customEventEventName",
                "displayName": "Event Name",
                "simpleValueType": true,
                "enablingConditions": [
                  {
                    "paramName": "eventType",
                    "paramValue": "custom",
                    "type": "EQUALS"
                  }
                ],
                "help": "Optional.\u003cbr/\u003e\u003cbr/\u003eIf set, it will be used as the Event Action for custom conversion goals."
              }
            ],
            "help": ""
          },
          {
            "value": "inherit",
            "subParams": [],
            "displayValue": "Inherit from client",
            "help": "If the request follows the \u003cb\u003eGoogle Analytics 4 (GA4)\u003c/b\u003e schema, the following mappings will be applied to convert GA4 \u003ci\u003eEvent Names\u003c/i\u003e into the Microsoft UET Conversion API \u003ci\u003eEvent Type\u003c/i\u003e equivalent:\n\u003cbr/\u003e\n\u003cul\u003e\n\u003cli\u003epage_view → pageLoad\u003c/li\u003e\n\u003cli\u003esearch → custom (\u003ci\u003ePage Type\u003c/i\u003e \u003d searchresults; \u003ci\u003eEvent Name\u003c/i\u003e \u003d search)\u003c/li\u003e\n\u003cli\u003eview_search_results → custom (\u003ci\u003ePage Type\u003c/i\u003e \u003d searchresults; \u003ci\u003eEvent Name\u003c/i\u003e \u003d view_search_results)\u003c/li\u003e\n\u003cli\u003eview_item → custom (\u003ci\u003ePage Type\u003c/i\u003e \u003d product; \u003ci\u003eEvent Name\u003c/i\u003e \u003d view_item)\u003c/li\u003e\n\u003cli\u003eview_cart → custom (\u003ci\u003ePage Type\u003c/i\u003e \u003d cart; \u003ci\u003eEvent Name\u003c/i\u003e \u003d view_cart)\u003c/li\u003e\n\u003cli\u003epurchase → custom (\u003ci\u003ePage Type\u003c/i\u003e \u003d purchase; \u003ci\u003eEvent Name\u003c/i\u003e \u003d purchase)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cbr/\u003e\nPlease note that it provides partial event mapping. Not all GA4 events can be mapped to Microsoft UET Conversion API events."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "standard"
      },
      {
        "type": "TEXT",
        "name": "uetTagId",
        "displayName": "UET Tag ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ],
        "help": "The UET Tag ID associated with your account.\n\u003cbr/\u003e\u003cbr/\u003e \nYou can find the UET Tag ID in Microsoft Advertising by selecting \u003cb\u003eConversion Tracking\u003c/b\u003e \u003e \u003cb\u003eUET tag\u003c/b\u003e.",
        "valueHint": "12345678"
      },
      {
        "type": "TEXT",
        "name": "authToken",
        "displayName": "Authorization Token",
        "simpleValueType": true,
        "help": "The Authorization Token associated with the account.\n\u003cbr/\u003e\nContact your Account Manager to get it, or generate it in Microsoft Ads.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "clientSideIdSyncGroup",
        "subParams": [
          {
            "type": "SELECT",
            "name": "enableClientSideIdSync",
            "displayName": "Enable Client-Side ID Sync",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": true,
                "displayValue": "true"
              },
              {
                "value": false,
                "displayValue": "false"
              }
            ],
            "simpleValueType": true,
            "help": "ID sync allows your internal IDs to be mapped to Microsoft IDs. This is strongly recommended for any Microsoft Advertising products that must identify a user off-site, such as remarketing.\n\u003cbr/\u003e\u003cbr/\u003e\nIf enabled, you must send an Anonymous ID and optionally (but highly recommended) a User ID.",
            "subParams": [
              {
                "type": "GROUP",
                "name": "enableClientSideIdSyncSettingsGroup",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "accountCustomerId",
                    "displayName": "Microsoft Customer ID / Manager Account ID",
                    "simpleValueType": true,
                    "valueValidators": [
                      {
                        "type": "NON_EMPTY"
                      },
                      {
                        "type": "POSITIVE_NUMBER"
                      }
                    ],
                    "help": "Use the primary Microsoft Customer ID (the one from the Manager Account).\n\u003cbr/\u003e\nIt\u0027s not the same as the UET Tag ID.\n\u003cbr/\u003e\u003cbr/\u003e\nYou can find it by looking for the \u003ci\u003ecid\u003c/i\u003e URL parameter when visiting your Microsoft Adverstising account.\n\u003cbr/\u003e\ne.g. \u003ci\u003ehttps://ui.ads.microsoft.com/[...]/?[...]\u0026\u003cb\u003ecid\u003d{Microsoft Customer ID}\u003c/b\u003e\u0026[...]\u003c/i\u003e",
                    "valueHint": "12345678"
                  }
                ],
                "enablingConditions": [
                  {
                    "paramName": "enableClientSideIdSync",
                    "paramValue": false,
                    "type": "NOT_EQUALS"
                  }
                ]
              }
            ],
            "defaultValue": true
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "useOptimisticScenario",
        "displayName": "Use Optimistic Scenario",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
        "defaultValue": false
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "idCookiesSettings",
    "displayName": "Anonymous ID and Click ID Settings",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "setAnonymousIdCookie",
        "displayName": "Set Anonymous ID cookie (Web only)",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "false"
          },
          {
            "value": true,
            "displayValue": "true"
          }
        ],
        "simpleValueType": true,
        "help": "If \u003cb\u003efalse\u003c/b\u003e, and if an existing Anonymous ID cookie is found or was added to the \u003ci\u003eUser Data Parameters\u003c/i\u003e, it will still be sent in the request but not stored as a cookie. It won\u0027t be auto-generated.\n\u003cbr/\u003e\u003cbr/\u003e\nIf \u003cb\u003etrue\u003c/b\u003e, the Anonymous ID will be sent in the request and stored as the \u003ci\u003euet_vid\u003c/i\u003e cookie by server GTM. If it\u0027s not found in the possible sources, it will be auto-generated.\n\u003cbr/\u003e\u003cbr/\u003e\nThe Anonymous ID is, in this order, sourced from:\n\u003cul\u003e\n\u003cli\u003e\u003ci\u003euet_vid\u003c/i\u003e cookie from server GTM\u003c/li\u003e\n\u003cli\u003e\u003ci\u003ecommonCookie.uet_vid\u003c/i\u003e Event Data parameter\u003c/li\u003e\n\u003cli\u003e\u003ci\u003e_uetvid\u003c/i\u003e cookie from the JS script\u003c/li\u003e\n\u003cli\u003e\u003ci\u003ecommonCookie._uetvid\u003c/i\u003e Event Data parameter\u003c/li\u003e\n\u003cli\u003e\u003ci\u003eUser Data Parameters\u003c/i\u003e section\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true,
        "subParams": [
          {
            "type": "GROUP",
            "name": "anonymousIdCookieSettingsGroup",
            "displayName": "Anonymous ID Cookie Settings",
            "groupStyle": "ZIPPY_CLOSED",
            "subParams": [
              {
                "type": "TEXT",
                "name": "anonymousIdCookieDomain",
                "displayName": "Cookie Domain",
                "simpleValueType": true,
                "defaultValue": "auto",
                "valueHint": "example.com",
                "help": "Use this option to override the cookie domain.\n\u003cbr\u003e\nEnter your website\u0027s top-level domain as a fixed value (e.g., example.com).\n\u003cbr\u003e\nIf left as \u003ci\u003eauto\u003c/i\u003e, the domain will be automatically determined using the following priority:\n\u003cul\u003e\n\u003cli\u003eDomain of the \u003ci\u003eForwarded\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eX-Forwarded-Host\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eHost\u003c/i\u003e header.\u003c/li\u003e\n\u003c/ul\u003e",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "type": "TEXT",
                "name": "anonymousIdCookieExpiration",
                "displayName": "Cookie Expiration",
                "simpleValueType": true,
                "defaultValue": 390,
                "valueUnit": "days",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "type": "SELECT",
                "name": "anonymousIdCookieHttpOnly",
                "displayName": "Cookie HTTP Only Flag",
                "macrosInSelect": false,
                "selectItems": [
                  {
                    "value": false,
                    "displayValue": "false"
                  },
                  {
                    "value": true,
                    "displayValue": "true"
                  }
                ],
                "simpleValueType": true,
                "defaultValue": false
              }
            ],
            "enablingConditions": [
              {
                "paramName": "setAnonymousIdCookie",
                "paramValue": false,
                "type": "NOT_EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "setClickIdCookie",
        "displayName": "Set Click ID cookie (Web only)",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "false"
          },
          {
            "value": true,
            "displayValue": "true"
          }
        ],
        "simpleValueType": true,
        "help": "If \u003cb\u003efalse\u003c/b\u003e, and if an existing Click ID cookie or URL parameter is found or was added to the \u003ci\u003eUser Data Parameters\u003c/i\u003e,, it will still be sent in the request but not stored as a cookie.\n\u003cbr/\u003e\u003cbr/\u003e\nIf \u003cb\u003etrue\u003c/b\u003e, the Click ID will be sent in the request and stored as the \u003ci\u003euet_msclkid\u003c/i\u003e cookie by server GTM.\n\u003cbr/\u003e\u003cbr/\u003e\nThe Click ID is, in this order, sourced from:\n\u003cul\u003e\n\u003cli\u003e\u003ci\u003emsclkid\u003c/i\u003e URL parameter\u003c/li\u003e\n\u003cli\u003e\u003ci\u003euet_msclkid\u003c/i\u003e cookie from server GTM\u003c/li\u003e\n\u003cli\u003e\u003ci\u003ecommonCookie.uet_msclkid\u003c/i\u003e Event Data parameter\u003c/li\u003e\n\u003cli\u003e\u003ci\u003e_uetmsclkid\u003c/i\u003e cookie from the JS script\u003c/li\u003e\n\u003cli\u003e\u003ci\u003ecommonCookie._uetmsclkid\u003c/i\u003e Event Data parameter\u003c/li\u003e\n\u003cli\u003e\u003ci\u003eUser Data Parameters\u003c/i\u003e section\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true,
        "subParams": [
          {
            "type": "GROUP",
            "name": "clickIdCookieSettingsGroup",
            "displayName": "Click ID Cookie Settings",
            "groupStyle": "ZIPPY_CLOSED",
            "subParams": [
              {
                "type": "TEXT",
                "name": "clickIdCookieDomain",
                "displayName": "Cookie Domain",
                "simpleValueType": true,
                "defaultValue": "auto",
                "valueHint": "example.com",
                "help": "Use this option to override the cookie domain.\n\u003cbr\u003e\nEnter your website\u0027s top-level domain as a fixed value (e.g., example.com).\n\u003cbr\u003e\nIf left as \u003ci\u003eauto\u003c/i\u003e, the domain will be automatically determined using the following priority:\n\u003cul\u003e\n\u003cli\u003eDomain of the \u003ci\u003eForwarded\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eX-Forwarded-Host\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eHost\u003c/i\u003e header.\u003c/li\u003e\n\u003c/ul\u003e",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "type": "TEXT",
                "name": "clickIdCookieExpiration",
                "displayName": "Cookie Expiration",
                "simpleValueType": true,
                "defaultValue": 90,
                "valueUnit": "days",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "type": "SELECT",
                "name": "clickIdCookieHttpOnly",
                "displayName": "Cookie HTTP Only Flag",
                "macrosInSelect": false,
                "selectItems": [
                  {
                    "value": false,
                    "displayValue": "false"
                  },
                  {
                    "value": true,
                    "displayValue": "true"
                  }
                ],
                "simpleValueType": true,
                "defaultValue": false
              }
            ],
            "enablingConditions": [
              {
                "paramName": "setClickIdCookie",
                "paramValue": false,
                "type": "NOT_EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "serverEventDataGroup",
    "displayName": "Server Event Data Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "consent",
        "displayName": "Consent Granted for Ad Storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If \u003ci\u003etrue\u003c/i\u003e, Ad Storage Consent is considered granted. If \u003ci\u003efalse\u003c/i\u003e, Ad Storage Consent is considered denied.\n\u003cbr/\u003e\u003cbr/\u003e\nEvents with Ad Storage Consent \u003cb\u003edenied\u003c/b\u003e will not be used for any ad purposes (including conversion attribution and retargeting).\n\u003cbr/\u003e\u003cbr/\u003e\nIf Ad Storage Consent is not set, it will be considered as granted.",
        "notSetText": "(not set)"
      },
      {
        "type": "SELECT",
        "name": "autoMapServerEventDataParameters",
        "displayName": "Auto-map Server Event Data Parameters",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If enabled, the tag will attempt to automatically map parameters from the Event Data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eEvent ID: \u003ci\u003eeventData.event_id \u003e eventData.eventId\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eEvent Source URL: \u003ci\u003eeventData.page_location\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eEvent Time: \u003ci\u003e\u003c/i\u003etimestamp in seconds of when the server tag fired\u003c/li\u003e\n\u003cli\u003ePage Title: \u003ci\u003eeventData.page_title\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eReferrer URL: \u003ci\u003eeventData.page_referrer\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "serverEventDataList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "eventId",
                "displayValue": "Event ID"
              },
              {
                "value": "eventSourceUrl",
                "displayValue": "Event Source URL"
              },
              {
                "value": "eventTime",
                "displayValue": "Event Time (UNIX timestamp in seconds)"
              },
              {
                "value": "pageLoadId",
                "displayValue": "Page Load ID"
              },
              {
                "value": "keywords",
                "displayValue": "Page Keywords"
              },
              {
                "value": "pageTitle",
                "displayValue": "Page Title"
              },
              {
                "value": "referrerUrl",
                "displayValue": "Referrer URL"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "userDataParametersGroup",
    "displayName": "User Data Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "autoMapUserDataParameters",
        "displayName": "Automap User Data Parameters",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If enabled, the tag will attempt to automatically map parameters from your event data. \n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eAnonymous ID: \u003ci\u003euet_vid cookie \u003e eventData.commonCookie.uet_vid \u003e _uetvid cookie \u003e eventData.commonCookie._uetvid\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eExternal ID: \u003ci\u003eeventData.user_id\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eClick ID: \u003ci\u003emsclkid URL parameter \u003e uet_msclkid cookie \u003e eventData.commonCookie.uet_msclkid \u003e _uetmsclkid cookie \u003e eventData.commonCookie._uetmsclkid\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eEmail: \u003ci\u003eeventData.email \u003e eventData.email_address \u003e eventData.userData.email \u003e eventData.userData.email_address \u003e eventData.userData.sha256_email_address\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003ePhone: \u003ci\u003eeventData.phone \u003e eventData.phone_number \u003e eventData.userData.phone\u003c/i\u003e \u003e eventData.userData.phone_number \u003e eventData.userData.sha256_phone_number\u003c/li\u003e\n\u003cli\u003eIP Address: \u003ci\u003eeventData.ip_override\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eUser Agent: \u003ci\u003eeventData.user_agent\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eiOS IDFA: \u003ci\u003eeventData[\u0027x-ga-resettable_device_id\u0027]\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eAndroid AAID/GAID: \u003ci\u003eeventData[\u0027x-ga-resettable_device_id\u0027]\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true
      },
      {
        "type": "SELECT",
        "name": "userDataParametersObject",
        "displayName": "User Data Parameters Object",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Provide an object with User Data Parameters to merge with the parameters below. Any conflicting parameters will be overwritten with them.",
        "notSetText": "(not set)"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "userDataParametersList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "anonymousId",
                "displayValue": "Anonymous ID"
              },
              {
                "value": "externalId",
                "displayValue": "External ID (if not SHA256 hashed, it will be automatically hashed)"
              },
              {
                "value": "msclkid",
                "displayValue": "Click ID"
              },
              {
                "value": "em",
                "displayValue": "Email (single item - if not SHA256 hashed, it will be automatically hashed)"
              },
              {
                "value": "ph",
                "displayValue": "Phone Number (single item in E.164 format - if not SHA256 hashed, it will be automatically hashed)"
              },
              {
                "value": "clientIpAddress",
                "displayValue": "IP Address"
              },
              {
                "value": "clientUserAgent",
                "displayValue": "User Agent"
              },
              {
                "value": "idfa",
                "displayValue": "iOS IDFA"
              },
              {
                "value": "gaid",
                "displayValue": "Android AAID/GAID"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventParametersGroup",
    "displayName": "Event Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "SELECT",
        "name": "pageType",
        "displayName": "Page Type",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "home",
            "displayValue": "home"
          },
          {
            "value": "category",
            "displayValue": "category"
          },
          {
            "value": "product",
            "displayValue": "product"
          },
          {
            "value": "searchresults",
            "displayValue": "searchresults"
          },
          {
            "value": "cart",
            "displayValue": "cart"
          },
          {
            "value": "purchase",
            "displayValue": "purchase"
          },
          {
            "value": "other",
            "displayValue": "other"
          }
        ],
        "simpleValueType": true,
        "notSetText": "(not set)"
      },
      {
        "type": "SELECT",
        "name": "autoMapEventParameters",
        "displayName": "Automap Event Parameters",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If enabled, the tag will attempt to automatically map parameters from your event data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eEvent Value, Value and Ecomm Total Value: \u003ci\u003eeventData.value \u003e Sum of eventData.items Price * Quantity\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eCurrency: \u003ci\u003eeventData.currency \u003e Currency from eventData.items\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eTransaction ID: \u003ci\u003eeventData.transaction_id\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eItems: \u003ci\u003eeventData.items\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eItem IDs: \u003ci\u003eeventData.items[].item_id\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eSearch Term: \u003ci\u003eeventData.search_term\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "itemIdKey",
            "displayName": "Custom Item ID Key",
            "simpleValueType": true,
            "help": "Optional.\n\u003cbr/\u003e\u003cbr/\u003e\nYou can specify a custom key, which will be used to set the content Item ID, by default \u003ci\u003eitem_id\u003c/i\u003e will be used. This may be useful if you are using WooCommerce extensions.",
            "canBeEmptyString": true,
            "enablingConditions": [
              {
                "paramName": "autoMapEventParameters",
                "paramValue": false,
                "type": "NOT_EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "eventParametersObject",
        "displayName": "Event Parameters Object",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Provide an object with Event Parameters to merge with the parameters below. Any conflicting parameters will be overwritten with them.",
        "notSetText": "(not set)"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "eventParametersList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "eventCategory",
                "displayValue": "Event Category ID"
              },
              {
                "value": "eventLabel",
                "displayValue": "Event Label"
              },
              {
                "value": "eventValue",
                "displayValue": "Event Value"
              },
              {
                "value": "searchTerm",
                "displayValue": "Search Term"
              },
              {
                "value": "transactionId",
                "displayValue": "Transaction ID"
              },
              {
                "value": "value",
                "displayValue": "Revenue Value"
              },
              {
                "value": "currency",
                "displayValue": "Currency"
              },
              {
                "value": "items",
                "displayValue": "Items (array of objects with id, quantity, name and price)"
              },
              {
                "value": "itemIds",
                "displayValue": "Item IDs (array of IDs)"
              },
              {
                "value": "ecommTotalValue",
                "displayValue": "Ecomm Total Value"
              },
              {
                "value": "ecommCategory",
                "displayValue": "Ecomm Category"
              },
              {
                "value": "hotelData.totalPrice",
                "displayValue": "Hotal Data Total Price (including taxes and fees)"
              },
              {
                "value": "hotelData.basePrice",
                "displayValue": "Hotal Data Base Price (not including taxes and fees)"
              },
              {
                "value": "hotelData.checkinDate",
                "displayValue": "Hotal Data Check-in Date (YYYY-MM-DD)"
              },
              {
                "value": "hotelData.checkoutDate",
                "displayValue": "Hotal Data Check-out Date (YYYY-MM-DD)"
              },
              {
                "value": "hotelData.lengthOfStay",
                "displayValue": "Hotal Data Lenght of Stay"
              },
              {
                "value": "hotelData.partnerHotelId",
                "displayValue": "Hotal Data Partner Hotel ID"
              },
              {
                "value": "hotelData.bookingHref",
                "displayValue": "Hotal Data Booking Reference"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "tagExecutionConsentSettingsGroup",
    "displayName": "Tag Execution Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr/\u003e\u003cbr/\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

/// <reference path="./server-gtm-sandboxed-apis.d.ts" />

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const generateRandom = require('generateRandom');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const Object = require('Object');
const parseUrl = require('parseUrl');
const sendHttpRequest = require('sendHttpRequest');
const sendPixelFromBrowser = require('sendPixelFromBrowser');
const setCookie = require('setCookie');
const sha256Sync = require('sha256Sync');

/*==============================================================================
==============================================================================*/

const traceId = getRequestHeader('trace-id');
const eventData = getAllEventData();
const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const mappedData = mapEvent(data, eventData);

setClickIdCookie(data, mappedData.data[0].userData.msclkid);
setAnonymousIdCookie(data, mappedData.data[0].userData.anonymousId);
sendIdSyncFromBrowser(data, mappedData);
sendRequest(data, mappedData);

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function parseClickIdFromUrl(eventData) {
  const url = eventData.page_location || getRequestHeader('referer');
  if (!url) return;

  const urlSearchParams = parseUrl(url).searchParams;
  return urlSearchParams.msclkid;
}

function getClickId(eventData) {
  const commonCookie = eventData.commonCookie || {};

  const clickIdFromUrl = parseClickIdFromUrl(eventData);
  if (clickIdFromUrl) return clickIdFromUrl;

  const clickIdFromServerCookie = getCookieValues('uet_msclkid')[0] || commonCookie.uet_msclkid;
  if (clickIdFromServerCookie) return clickIdFromServerCookie;

  const clickIdFromJSCookie = getCookieValues('_uetmsclkid')[0] || commonCookie._uetmsclkid;
  if (clickIdFromJSCookie) return clickIdFromJSCookie.replace('_uet', '');
}

function setClickIdCookie(data, clickId) {
  if (!isUIFieldTrue(data.setClickIdCookie) || !clickId) return;

  const cookieOptions = {
    domain: data.clickIdCookieDomain || 'auto',
    samesite: 'Lax',
    path: '/',
    secure: true,
    httpOnly: !!data.clickIdCookieHttpOnly,
    'max-age': 60 * 60 * 24 * makeInteger(data.clickIdCookieExpiration || 90)
  };

  setCookie('uet_msclkid', clickId, cookieOptions, false);
}

function getAnonymousId(eventData) {
  const commonCookie = eventData.commonCookie || {};

  const anonymousIdFromServerCookie = getCookieValues('uet_vid')[0] || commonCookie._uet_vid;
  if (anonymousIdFromServerCookie) return anonymousIdFromServerCookie;

  const anonymousIdFromJSCookie = getCookieValues('_uetvid')[0] || commonCookie._uetvid;
  if (anonymousIdFromJSCookie) return anonymousIdFromJSCookie;

  if (isUIFieldTrue(data.setAnonymousIdCookie)) return generateUUID();
}

function setAnonymousIdCookie(data, anonymousId) {
  if (!isUIFieldTrue(data.setAnonymousIdCookie) || !anonymousId) return;

  const cookieOptions = {
    domain: data.anonymousIdCookieDomain || 'auto',
    samesite: 'Lax',
    path: '/',
    secure: true,
    httpOnly: !!data.anonymousIdCookieHttpOnly,
    'max-age': 60 * 60 * 24 * makeInteger(data.anonymousIdCookieExpiration || 390)
  };

  setCookie('uet_vid', anonymousId, cookieOptions, false);
}

function addServerEventData(data, eventData, event) {
  if (isUIFieldTrue(data.autoMapServerEventDataParameters)) {
    const eventId = eventData.event_id || eventData.eventId;
    if (eventId) event.eventId = makeString(eventId);

    event.eventTime = makeInteger(getTimestampMillis() / 1000);

    if (eventData.page_location) event.eventSourceUrl = eventData.page_location;
    if (eventData.page_title) event.pageTitle = eventData.page_title;
    if (eventData.page_referrer) event.referrerUrl = eventData.page_referrer;
  }

  if (data.serverEventDataList) {
    data.serverEventDataList.forEach((d) => (event[d.name] = d.value));
  }

  if (isUIFieldFalse(data.consent)) event.adStorageConsent = 'D';
  else if (isUIFieldTrue(data.consent)) event.adStorageConsent = 'G';

  return event;
}

function addUserData(data, eventData, event) {
  const userData = {};

  if (isUIFieldTrue(data.autoMapUserDataParameters)) {
    const eventDataUserData = eventData.user_data || {};

    let email =
      eventData.email ||
      eventData.email_address ||
      eventDataUserData.email ||
      eventDataUserData.email_address ||
      eventDataUserData.sha256_email_address;
    const emailType = getType(email);
    if (emailType === 'array' || emailType === 'object') email = email[0];

    if (email) userData.em = email;

    let phone =
      eventData.phone ||
      eventData.phone_number ||
      eventDataUserData.phone ||
      eventDataUserData.phone_number ||
      eventDataUserData.sha256_phone_number;
    const phoneType = getType(phone);
    if (phoneType === 'array' || phoneType === 'object') phone = phone[0];

    if (phone) userData.ph = phone;

    if (eventData.user_id) userData.externalId = makeString(eventData.user_id);

    if (eventData.ip_override) userData.clientIpAddress = eventData.ip_override;

    if (eventData.user_agent) userData.clientUserAgent = eventData.user_agent;

    const mobileDeviceId = eventData['x-ga-resettable_device_id'];
    const platform = eventData['x-ga-platform'];
    if (mobileDeviceId) {
      if (platform === 'ios') userData.idfa = mobileDeviceId;
      else if (platform === 'android') userData.gaid = mobileDeviceId;
    }

    const clickId = getClickId(eventData);
    if (clickId) userData.msclkid = clickId;

    const anonymousId = getAnonymousId(eventData);
    if (anonymousId) userData.anonymousId = anonymousId;
  }

  if (getType(data.userDataParametersObject) === 'object') {
    mergeObj(userData, data.userDataParametersObject);
  }
  if (data.userDataParametersList) {
    data.userDataParametersList.forEach((d) => (userData[d.name] = d.value));
  }

  event.userData = userData;

  return event;
}

function addEventData(data, eventData, event) {
  const customData = {};

  if (isUIFieldTrue(data.autoMapServerEventDataParameters)) {
    let currencyFromItems;
    let valueFromItems;
    if (getType(eventData.items) === 'array' && eventData.items.length > 0) {
      customData.items = [];
      customData.itemIds = [];
      valueFromItems = 0;
      currencyFromItems = eventData.items[0].currency;
      const itemIdKey = data.itemIdKey ? data.itemIdKey : 'item_id';
      eventData.items.forEach((i) => {
        const item = {};
        if (i[itemIdKey]) item.id = makeString(i[itemIdKey]);
        if (i.item_name) item.name = makeString(i.item_name);
        if (i.quantity) item.quantity = makeInteger(i.quantity);
        if (isValidValue(i.price)) {
          item.price = makeNumber(i.price);
          valueFromItems += item.quantity ? item.quantity * item.price : item.price;
        }
        customData.items.push(item);
        customData.itemIds.push(item.id);
      });
    }

    if (isValidValue(eventData.value)) {
      const value = makeNumber(eventData.value);
      customData.value = value;
      customData.eventValue = value;
      customData.ecommTotalValue = value;
    } else if (isValidValue(valueFromItems)) {
      customData.value = valueFromItems;
      customData.eventValue = valueFromItems;
      customData.ecommTotalValue = valueFromItems;
    }

    const currency = eventData.currency || currencyFromItems;
    if (currency) customData.currency = makeString(currency);

    if (eventData.transaction_id) {
      customData.transactionId = makeString(eventData.transaction_id);
    }

    if (eventData.search_term) {
      customData.searchTerm = makeString(eventData.search_term);
    }
  }

  // Accounting for "Inherit from client" UI option
  const pageType = mapPageType(data, eventData);
  if (pageType) customData.pageType = makeString(pageType);

  if (getType(data.eventParametersObject) === 'object') {
    mergeObj(customData, data.eventParametersObject);
  }
  if (data.eventParametersList) {
    data.eventParametersList.forEach((d) => {
      const names = d.name.split('.');
      names.reduce((acc, name, index) => {
        const isLastKey = index === names.length - 1;
        if (isLastKey) acc[name] = d.value;
        else acc[name] = acc[name] || {};
        return acc[name];
      }, customData);
    });
  }

  event.customData = customData;

  return event;
}

function normalizeUserData(userData) {
  const normalizeEmail = (email) => {
    if (!email) return email;
    const emailSplit = email.split('@');
    emailSplit[0] = emailSplit[0].split('.').join('').split('+')[0];
    return emailSplit.join('@');
  };

  const normalizePhoneNumber = (phoneNumber) => {
    if (!phoneNumber) return phoneNumber;
    return phoneNumber
      .split(' ')
      .join('')
      .split('-')
      .join('')
      .split('(')
      .join('')
      .split(')')
      .join('');
  };

  if (userData.em) userData.em = normalizeEmail(userData.em);
  if (userData.ph) userData.ph = normalizePhoneNumber(userData.ph);

  return userData;
}

function hashDataIfNeeded(event) {
  const userData = event.userData;
  const hasUserData = getType(userData) === 'object' && Object.entries(userData).length > 0;
  if (hasUserData) {
    normalizeUserData(userData);
    const userDataKeysToHash = ['em', 'ph', 'externalId'];
    userDataKeysToHash.forEach((key) => {
      const value = userData[key];
      if (!value) return;
      userData[key] = hashData(value);
    });
  }

  return event;
}

function mapEventType(data, eventData) {
  if (data.eventTypeSetupMethod === 'inherit') {
    const eventName = eventData.event_name;

    const gaToEventType = {
      page_view: 'pageLoad',
      'gtm.dom': 'pageLoad',
      search: 'custom',
      view_search_results: 'custom',
      view_item: 'custom',
      view_cart: 'custom',
      purchase: 'custom'
    };

    if (gaToEventType[eventName]) {
      return gaToEventType[eventName];
    }

    return 'custom';
  } else if (data.eventTypeSetupMethod === 'standard') {
    return data.eventType;
  }
}

function mapEventName(data, eventData) {
  if (data.eventTypeSetupMethod === 'inherit') {
    const eventName = eventData.event_name;

    const gaToEventName = {
      search: 'search',
      view_search_results: 'view_search_results',
      view_item: 'view_item',
      view_cart: 'view_cart',
      purchase: 'purchase'
    };

    if (gaToEventName[eventName]) {
      return gaToEventName[eventName];
    }
  } else if (data.eventTypeSetupMethod === 'standard') {
    return data.customEventEventName;
  }
}

function mapPageType(data, eventData) {
  if (data.pageType) return data.pageType;
  else if (data.eventTypeSetupMethod === 'inherit') {
    const eventName = eventData.event_name;

    const gaToPageType = {
      search: 'searchresults',
      view_search_results: 'searchresults',
      view_item: 'product',
      view_cart: 'cart',
      purchase: 'purchase'
    };

    if (gaToPageType[eventName]) {
      return gaToPageType[eventName];
    }
  }
}

function mapEvent(data, eventData) {
  const event = {
    eventType: mapEventType(data, eventData),
    eventName: mapEventName(data, eventData)
  };
  const mappedData = {
    data: [event]
  };

  addServerEventData(data, eventData, event);
  addUserData(data, eventData, event);
  addEventData(data, eventData, event);
  hashDataIfNeeded(event);

  return mappedData;
}

function sendIdSyncFromBrowser(data, mappedData) {
  if (!isUIFieldTrue(data.enableClientSideIdSync)) return;

  const event = mappedData.data[0];

  const accountCustomerId = data.accountCustomerId;
  const anonymousId = event.userData.anonymousId;
  if (!accountCustomerId || !anonymousId) {
    log({
      Name: 'MicrosoftCAPI',
      Type: 'Message',
      TraceId: traceId,
      EventName: 'ClientSideIDSync',
      Message: 'Client-Side ID Sync request was not sent.',
      Reason: 'One or more required parameters are missing: accountCustomerId or anonymousId'
    });

    return;
  }

  let idSyncRequestUrl =
    'https://c.bing.com/c.gif?Red3=BACID_' + enc(accountCustomerId) + '&vid=' + enc(anonymousId);

  const userId = event.userData.externalId;
  if (userId) idSyncRequestUrl += '&uid=' + enc(userId);

  sendPixelFromBrowser(idSyncRequestUrl);
}

function generateRequestBaseUrl(data) {
  const version = 'v1';
  return 'https://capi.uet.microsoft.com/' + version + '/' + enc(data.uetTagId) + '/events';
}

function generateRequestOptions(data) {
  const options = {
    method: 'POST',
    headers: {
      Authorization: 'Bearer ' + data.authToken,
      'Content-Type': 'application/json'
    }
  };

  return options;
}

function sendRequest(data, mappedData) {
  const requestUrl = generateRequestBaseUrl(data);
  const requestOptions = generateRequestOptions(data);

  log({
    Name: 'MicrosoftCAPI',
    Type: 'Request',
    TraceId: traceId,
    EventName: mappedData.data[0].eventType,
    RequestMethod: requestOptions.method,
    RequestUrl: requestUrl,
    RequestBody: mappedData
  });

  return sendHttpRequest(
    requestUrl,
    (statusCode, headers, body) => {
      log({
        Name: 'MicrosoftCAPI',
        Type: 'Response',
        TraceId: traceId,
        EventName: mappedData.data[0].eventType,
        ResponseStatusCode: statusCode,
        ResponseHeaders: headers,
        ResponseBody: body
      });

      if (!useOptimisticScenario) {
        if (statusCode >= 200 && statusCode < 400) data.gtmOnSuccess();
        else data.gtmOnFailure();
      }
    },
    requestOptions,
    JSON.stringify(mappedData)
  );
}

/*==============================================================================
  Helpers
==============================================================================*/

function mergeObj(target, source) {
  for (const key in source) {
    if (source.hasOwnProperty(key)) target[key] = source[key];
  }
  return target;
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function isUIFieldFalse(field) {
  return [false, 'false'].indexOf(field) !== -1;
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function random() {
  return generateRandom(1000000000000000, 10000000000000000) / 10000000000000000;
}

function generateUUID() {
  function s(n) {
    return h((random() * (1 << (n << 2))) ^ getTimestampMillis()).slice(-n);
  }
  function h(n) {
    return (n | 0).toString(16);
  }
  return [
    s(4) + s(4),
    s(4),
    '4' + s(3),
    h(8 | (random() * 4)) + s(3),
    getTimestampMillis().toString(16).slice(-10) + s(2)
  ].join('');
}

function isHashed(value) {
  if (!value) return false;
  return makeString(value).match('^[A-Fa-f0-9]{64}$') !== null;
}

function hashData(value) {
  if (!value) return value;

  const type = getType(value);

  if (value === 'undefined' || value === 'null') return undefined;

  if (type === 'array') {
    return value.map((val) => hashData(val));
  }

  if (type === 'object') {
    return Object.keys(value).reduce((acc, val) => {
      acc[val] = hashData(value[val]);
      return acc;
    }, {});
  }

  if (isHashed(value)) return value;

  return sha256Sync(makeString(value).trim().toLowerCase(), {
    outputEncoding: 'hex'
  });
}

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  const bigquery =
    getType(BigQuery) === 'function' ? BigQuery() /* Only during Unit Tests */ : BigQuery;
  bigquery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "uet_msclkid"
              },
              {
                "type": 1,
                "string": "_uetmsclkid"
              },
              {
                "type": 1,
                "string": "uet_vid"
              },
              {
                "type": 1,
                "string": "_uetvid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "uet_msclkid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "uet_vid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://capi.uet.microsoft.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel_from_browser",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://c.bing.com/c.gif?*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[Anonymous ID cookie] Is NOT set or auto-generated when the option is not
    active'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setAnonymousIdCookie: false,
      userDataParametersList: [{ name: 'anonymousId', value: 'anonymousId' }]
    });

    mock('setCookie', (cookieName) => {
      if (cookieName === anonymousIdCookieNames.server) fail(anonymousIdCookieNames.server + ' should not have been set.');
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.anonymousId).isEqualTo('anonymousId');
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Anonymous ID cookie] Is NOT set when the option is active, and Anonymous
    ID is a falsy value'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setAnonymousIdCookie: true,
      userDataParametersObject: undefined,
      userDataParametersList: [{ name: 'anonymousId', value: undefined }]
    });

    mock('setCookie', (cookieName) => {
      if (cookieName === anonymousIdCookieNames.server) fail(anonymousIdCookieNames.server + ' should not have been set.');
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.anonymousId).isUndefined();
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Anonymous ID cookie] Is set when the option is active, and Anonymous ID
    was read from Cookie'
  code: "setAllMockDataByEventType('pageLoad', {\n  setAnonymousIdCookie: true,\n\
    \  userDataParametersObject: undefined,\n  userDataParametersList: undefined\n\
    });\n\n[\n  { serverCookieValue: 'serverCookieValue', jsCookieValue: undefined,\
    \ expectedValue: 'serverCookieValue' },\n  { serverCookieValue: 'serverCookieValue',\
    \ jsCookieValue: '561f11b5eb0d1674e37c79103d290385', expectedValue: 'serverCookieValue'\
    \ },\n  { serverCookieValue: undefined, jsCookieValue: '561f11b5eb0d1674e37c79103d290385',\
    \ expectedValue: '561f11b5eb0d1674e37c79103d290385' }\n].forEach(scenario => {\n\
    \  mock('getCookieValues', (cookieName) => {\n    if (cookieName === anonymousIdCookieNames.server)\
    \ return [scenario.serverCookieValue];\n    else if (cookieName === anonymousIdCookieNames.js)\
    \ return [scenario.jsCookieValue];\n    return [];\n  });\n  \n  mock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions, requestBody) => {\n    const parsedBody\
    \ = JSON.parse(requestBody);\n    assertThat(parsedBody.data[0].userData.anonymousId).isEqualTo(scenario.expectedValue);\n\
    \    callback(200);\n  });\n  \n  runCode(mockData);\n  \n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n  assertApi('setCookie').wasCalledWith(anonymousIdCookieNames.server,\
    \ scenario.expectedValue, getExpectedCookieOptions('anonymousId'), false);\n});"
- name: '[Anonymous ID cookie] Is set when the option is active, and Anonymous ID
    was set on UI field'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setAnonymousIdCookie: true,
      userDataParametersObject: undefined,
      userDataParametersList: [{ name: 'anonymousId', value: 'anonymousId' }]
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.anonymousId).isEqualTo('anonymousId');
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasCalledWith(anonymousIdCookieNames.server, 'anonymousId', getExpectedCookieOptions('anonymousId'), false);
- name: '[Anonymous ID cookie] is set when the option is active, and Anonymous ID
    was randomly generated'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setAnonymousIdCookie: true,
      userDataParametersObject: undefined,
      userDataParametersList: undefined
    });

    mock('getCookieValues', (cookieName) => {
      return [];
    });

    let anonymousId;
    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      anonymousId = parsedBody.data[0].userData.anonymousId;
      assertThat(anonymousId).isDefined();
      assertThat(anonymousId).hasLength(32);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasCalledWith(anonymousIdCookieNames.server, anonymousId, getExpectedCookieOptions('anonymousId'), false);
- name: '[Click ID cookie] Is NOT set when the option is not active'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setClientIdCookie: false,
      userDataParametersObject: undefined,
      userDataParametersList: [{ name: 'clickId', value: 'clickId' }]
    });

    mock('setCookie', (cookieName) => {
      if (cookieName === clickIdCookieNames.server) fail(clickIdCookieNames.server + ' should not have been set.');
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.clickId).isEqualTo('clickId');
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Click ID cookie] Is NOT set when the option is active, and Click ID is a
    falsy value'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setClickIdCookie: true,
      userDataParametersList: [{ name: 'msclkid', value: undefined }]
    });

    mock('setCookie', (cookieName) => {
      if (cookieName === clickIdCookieNames.server) fail(clickIdCookieNames.server + ' should not have been set.');
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.msclkid).isUndefined();
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Click ID cookie] Is set when the option is active, and Click ID was read
    from URL'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setClickIdCookie: true,
      userDataParametersObject: undefined,
      userDataParametersList: undefined
    });

    const expectedClickId = 'dd4afcccb1c9a4cad9544dd7e5006';
    setGetAllEventData({
      page_location: 'https://example.com?utm_source=test&msclkid=' + expectedClickId
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.msclkid).isEqualTo(expectedClickId);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasCalledWith(clickIdCookieNames.server, expectedClickId, getExpectedCookieOptions('clickId'), false);
- name: '[Click ID cookie] Is set when the option is active, and Click ID was set
    from on UI field'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      setClickIdCookie: true,
      userDataParametersObject: undefined,
      userDataParametersList: [{ name: 'msclkid', value: 'clickId' }]
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody.data[0].userData.msclkid).isEqualTo('clickId');
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasCalledWith(clickIdCookieNames.server, 'clickId', getExpectedCookieOptions('clickId'), false);
- name: '[Click ID cookie] Is set when the option is active, and Click ID was read
    from Cookie'
  code: "setAllMockDataByEventType('pageLoad', {\n  setClickIdCookie: true,\n  userDataParametersObject:\
    \ undefined,\n  userDataParametersList: undefined\n});\n\n[\n  { serverCookieValue:\
    \ 'serverCookieValue', jsCookieValue: undefined, expectedValue: 'serverCookieValue'\
    \ },\n  { serverCookieValue: 'serverCookieValue', jsCookieValue: '561f11b5eb0d1674e37c79103d290385',\
    \ expectedValue: 'serverCookieValue' },\n  { serverCookieValue: undefined, jsCookieValue:\
    \ '_uet561f11b5eb0d1674e37c79103d290385', expectedValue: '561f11b5eb0d1674e37c79103d290385'\
    \ },\n].forEach(scenario => {\n  mock('getCookieValues', (cookieName) => {\n \
    \   if (cookieName === clickIdCookieNames.server) return [scenario.serverCookieValue];\n\
    \    else if (cookieName === clickIdCookieNames.js) return [scenario.jsCookieValue];\n\
    \    return [];\n  });\n  \n  mock('sendHttpRequest', (requestUrl, callback, requestOptions,\
    \ requestBody) => {\n    const parsedBody = JSON.parse(requestBody);\n    assertThat(parsedBody.data[0].userData.msclkid).isEqualTo(scenario.expectedValue);\n\
    \    callback(200);\n  });\n  \n  runCode(mockData);\n  \n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n  assertApi('setCookie').wasCalledWith(clickIdCookieNames.server,\
    \ scenario.expectedValue, getExpectedCookieOptions('clickId'), false);\n});"
- name: '[Client-Side ID Sync] Is NOT sent when the option is disabled'
  code: |-
    setAllMockDataByEventType('pageLoad', {
      enableClientSideIdSync: false
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('sendPixelFromBrowser').wasNotCalled();
- name: '[Client-Side ID Sync] Is NOT sent when required fields are missing'
  code: "const originalMockData = setAllMockDataByEventType('pageLoad', {\n  enableClientSideIdSync:\
    \ true,\n  setAnonymousIdCookie: false\n});\n\n[\n  { accountCustomerId: undefined,\
    \ userDataParametersObject: undefined, userDataParametersList: [{ name: 'anonymousId',\
    \ value: 'test' }] },\n  { accountCustomerId: '123', userDataParametersObject:\
    \ undefined, userDataParametersList: undefined },\n  { accountCustomerId: undefined,\
    \ userDataParametersObject: undefined, userDataParametersList: undefined },\n\
    ].forEach(scenario => {\n  const copyMockData = JSON.parse(JSON.stringify(originalMockData));\n\
    \  mergeObj(copyMockData, scenario);\n  \n  runCode(copyMockData);\n  \n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n  assertApi('sendPixelFromBrowser').wasNotCalled();\n\
    });\n\n"
- name: '[Client-Side ID Sync] Is successfully built and sent'
  code: "const originalMockData = setAllMockDataByEventType('pageLoad', {\n  enableClientSideIdSync:\
    \ true,\n  setAnonymousIdCookie: false\n});\n\n[\n  { \n    scenario: { accountCustomerId:\
    \ '123', userDataParametersList: [{ name: 'anonymousId', value: 'test' }] }, \n\
    \    expectedUrl: 'https://c.bing.com/c.gif?Red3=BACID_123&vid=test' \n  },\n\
    \  { \n    scenario: { accountCustomerId: '123', userDataParametersList: [{ name:\
    \ 'anonymousId', value: 'test' }, { name: 'externalId', value: 'test' }] }, \n\
    \    expectedUrl: 'https://c.bing.com/c.gif?Red3=BACID_123&vid=test&uid=9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'\
    \ \n  }\n].forEach(testCase => {\n  const copyMockData = JSON.parse(JSON.stringify(originalMockData));\n\
    \  mergeObj(copyMockData, testCase.scenario);\n  \n  runCode(copyMockData);\n\
    \  \n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    \  assertApi('sendPixelFromBrowser').wasCalledWith(testCase.expectedUrl);\n});\n\
    \n"
- name: '[Request] URL and Options are successfully built and sent'
  code: |-
    setAllMockDataByEventType('pageLoad');

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      assertThat(requestUrl).isEqualTo('https://capi.uet.microsoft.com/v1/' + mockData.uetTagId + '/events');
      assertThat(requestOptions).isEqualTo({
        headers: {
          Authorization: 'Bearer ' + mockData.authToken,
          'Content-Type': 'application/json'
        },
        method: 'POST'
      });
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Request] [Data from auto-mapping] Is successfully built and sent'
  code: "setAllMockDataByEventType('custom', {\n  autoMapServerEventDataParameters:\
    \ true,\n  serverEventDataList: undefined,\n  autoMapEventParameters: true,\n\
    \  pageType: undefined,\n  eventParametersObject: undefined,\n  eventParametersList:\
    \ undefined,\n  autoMapUserDataParameters: true,\n  userDataParametersObject:\
    \ undefined, \n  userDataParametersList: undefined\n});\n\nsetGetAllEventData();\n\
    \nmock('getCookieValues', (cookieName) => {\n  if (cookieName === anonymousIdCookieNames.server)\
    \ return ['anonymousId'];\n  else if (cookieName === clickIdCookieNames.server)\
    \ return ['clickId'];\n  return [];\n});\n\nmock('sendHttpRequest', (requestUrl,\
    \ callback, requestOptions, requestBody) => {\n  const parsedBody = JSON.parse(requestBody);\n\
    \  assertThat(parsedBody).isEqualTo({\n    data: [\n      {\n        eventType:\
    \ 'custom',\n        eventName: 'test',\n        eventId: '101509157~103116025~103130498',\n\
    \        eventTime: 1747945830,\n        eventSourceUrl: 'https://example.com/?test=1i23i21j3',\n\
    \        pageTitle: 'Example Domain',\n        adStorageConsent: 'G',\n      \
    \  userData: {\n          em: '27c6b8e780cfc293ef0436f7d8421af0bed83caae706734b49f8e95d5295b462',\n\
    \          ph: 'c698c0b85d32cbcf5033ada58f34de87d4f7415efaf5a8d1c1e9e63393dcc85e',\n\
    \          externalId:\n            'fd14499abf2345243b9d48ce26e77f3e7c0f1117ee62a15c97340411b32c85ee',\n\
    \          clientIpAddress: '2804:14d:c096:8dd6:311c:8c00:e6c:e33',\n        \
    \  clientUserAgent:\n            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)\
    \ AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36',\n  \
    \        idfa: 'x-ga-resettable_device_id',\n          msclkid: 'clickId',\n \
    \         anonymousId: 'anonymousId'\n        },\n        customData: {\n    \
    \      items: [\n            {\n              id: 'SKU_12345',\n             \
    \ name: 'Stan and Friends Tee',\n              quantity: 3,\n              price:\
    \ 10.01\n            },\n            {\n              id: 'SKU_12346',\n     \
    \         name: \"Google Grey Women's (Tee)\",\n              quantity: 2,\n \
    \             price: 21.01\n            }\n          ],\n          itemIds: ['SKU_12345',\
    \ 'SKU_12346'],\n          value: 123.45,\n          eventValue: 123.45,\n   \
    \       ecommTotalValue: 123.45,\n          currency: 'BRL',\n          transactionId:\
    \ 'transaction_id',\n          searchTerm: 'search_term'\n        }\n      }\n\
    \    ]\n  });\n  callback(200);\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: '[Request] [Data from UI fields] Is successfully built and sent'
  code: |-
    setAllMockDataByEventType('custom', {
      autoMapServerEventDataParameters: true,
      autoMapEventParameters: true,
      autoMapUserDataParameters: true
    });

    setGetAllEventData();

    mock('getCookieValues', (cookieName) => {
      if (cookieName === anonymousIdCookieNames.server) return ['anonymousId'];
      else if (cookieName === clickIdCookieNames.server) return ['clickId'];
      return [];
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const parsedBody = JSON.parse(requestBody);
      assertThat(parsedBody).isEqualTo({
        data: [
          {
            eventType: 'custom',
            eventName: 'test',
            eventTime: 123456789,
            eventId: 'test',
            eventSourceUrl: 'test',
            pageLoadId: 'test',
            keywords: 'test',
            pageTitle: 'test',
            referrerUrl: 'test',
            adStorageConsent: 'G',
            userData: {
              anonymousId: 'test',
              externalId:
                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',
              msclkid: 'test',
              em: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',
              ph: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',
              clientIpAddress: 'test',
              clientUserAgent: 'test',
              idfa: 'test',
              gaid: 'test'
            },
            customData: {
              pageType: 'home',
              eventCategory: 'test',
              eventLabel: 'test',
              eventValue: 'test',
              searchTerm: 'test',
              transactionId: 'test',
              value: 'test',
              currency: 'test',
              items: [{ id: 'id', name: 'name', quantity: 1, price: 123.45 }],
              itemIds: ['foo', 'bar'],
              ecommTotalValue: 'test',
              ecommCategory: 'test',
              hotelData: {
                totalPrice: 'test',
                basePrice: 'test',
                checkinDate: 'test',
                checkoutDate: 'test',
                lengthOfStay: 'test',
                partnerHotelId: 'test',
                bookingHref: 'test'
              }
            }
          }
        ]
      });
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: '[Logs] Should log to console'
  code: "const originalMockData = setAllMockDataByEventType('pageLoad');\n\n[\n  //\
    \ if the 'Always log to console' option is selected\n  { mockData: { logType:\
    \ 'always' }, expectedDebugMode: true },\n  // if the 'Log during debug and preview'\
    \ option is selected AND is on preview mode\n  { mockData: { logType: 'debug'\
    \ }, expectedDebugMode: true },\n].forEach(scenario => {\n  const copyMockData\
    \ = JSON.parse(JSON.stringify(originalMockData));\n  mergeObj(copyMockData, scenario.mockData);\n\
    \  \n  mock('getContainerVersion', () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n\
    \    };\n  }); \n  \n  mock('logToConsole', (logData) => {\n    const parsedLogData\
    \ = JSON.parse(logData);\n    requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());\n\
    \  });\n  \n  runCode(copyMockData);\n  \n  assertApi('logToConsole').wasCalled();\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Logs] Should NOT log to console'
  code: "setAllMockDataByEventType('pageLoad');\nmockData.logType = 'debug';\n\nconst\
    \ originalMockData = setAllMockDataByEventType('pageLoad');\n\n[\n  // if the\
    \ 'Log during debug and preview' option is selected AND is NOT on preview mode\n\
    \  { mockData: { logType: 'debug' }, expectedDebugMode: false },\n  // if the\
    \ 'Do not log' option is selected\n  { mockData: { logType: 'no' }, expectedDebugMode:\
    \ undefined },\n].forEach(scenario => {\n  const copyMockData = JSON.parse(JSON.stringify(originalMockData));\n\
    \  mergeObj(copyMockData, scenario.mockData);\n  \n  mock('getContainerVersion',\
    \ () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n    };\n\
    \  });\n  \n  runCode(copyMockData);\n\n  assertApi('logToConsole').wasNotCalled();\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Logs] Should NOT log to BQ, if the ''Do not log to BigQuery'' option is
    selected'
  code: "setAllMockDataByEventType('pageLoad');\nmockData.bigQueryLogType = 'no';\n\
    \n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mock('BigQuery', () => {\n  return { \n    insert: (connectionInfo, rows, options)\
    \ => { \n      fail('BigQuery.insert should not have been called.');\n      return\
    \ Promise.create((resolve, reject) => {\n        resolve();\n      });\n    }\n\
    \  };\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
- name: '[Logs] Should log to BQ, if the ''Log to BigQuery'' option is selected'
  code: "setAllMockDataByEventType('pageLoad');\nmockData.bigQueryLogType = 'always';\n\
    \n// assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mock('BigQuery', () => {\n  return { \n    insert: (connectionInfo, rows, options)\
    \ => { \n      assertThat(connectionInfo).isDefined();\n      assertThat(rows).isArray();\n\
    \      assertThat(rows).hasLength(1);\n      requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \      assertThat(options).isEqualTo(expectedBqOptions);\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();"
setup: "const JSON = require('JSON');\nconst Promise = require('Promise');\nconst\
  \ parseUrl = require('parseUrl');\nconst Object = require('Object');\nconst makeInteger\
  \ = require('makeInteger');\n\nfunction mergeObj(target, source) {\n  for (const\
  \ key in source) {\n    if (source.hasOwnProperty(key)) target[key] = source[key];\n\
  \  }\n  return target;\n}\n\nconst setGetAllEventData = (objToBeMerged) => {\n \
  \ mock('getAllEventData', mergeObj({\n    'x-ga-protocol_version': '2',\n    'x-ga-measurement_id':\
  \ 'G-123ABC',\n    'x-ga-gtm_version': '45je55e1za200',\n    'x-ga-page_id': 1747422523211,\n\
  \    'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa': '0',\n    'x-ga-dma': '0',\n \
  \   'x-ga-mp2-tag_exp':\n      '101509157~103116025~103130498~103130500~103136993~103136995~103200001~103207802~103211513~103233427~103252644~103252646~103263073~103301114~103301116',\n\
  \    client_id: 'AUJctU7H7hBB/aMuhE4pKwGu5DWDdklg5abyyyn8i/I=.1747154479',\n   \
  \ 'x-ga-ecid': '1294673677',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    event_id: '101509157~103116025~103130498',\n\
  \    timestamp: 1748377016,\n    client_hints: {\n      architecture: 'arm',\n \
  \     bitness: '64',\n      full_version_list: [\n        { brand: 'Chromium', version:\
  \ '136.0.7103.93' },\n        { brand: 'Google Chrome', version: '136.0.7103.93'\
  \ },\n        { brand: 'Not.A/Brand', version: '99.0.0.0' }\n      ],\n      mobile:\
  \ false,\n      model: '',\n      platform: 'macOS',\n      platform_version: '15.2.0',\n\
  \      wow64: false,\n      brands: [\n        { brand: 'Chromium', version: '136'\
  \ },\n        { brand: 'Google Chrome', version: '136' },\n        { brand: 'Not.A/Brand',\
  \ version: '99' }\n      ]\n    },\n    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n\
  \    'x-ga-pscdl': 'noapi',\n    'x-ga-system_properties': { eu: [34], tu: 'BA',\
  \ ss: '1', ee: true },\n    'x-sst-system_properties': {\n      etld: 'google.com.br',\n\
  \      tft: '1747422523211',\n      lpc: '60493049',\n      navt: 'r',\n      ude:\
  \ '0',\n      sw_exp: '1',\n      request_start_time_ms: 1747422524851\n    },\n\
  \    'x-ga-request_count': 1,\n    'x-ga-platform': 'ios',\n    'x-ga-resettable_device_id':\
  \ 'x-ga-resettable_device_id',\n    ga_session_id: '1747422523',\n    ga_session_number:\
  \ 3,\n    'x-ga-mp2-seg': '0',\n    page_location: 'https://example.com/?test=1i23i21j3',\n\
  \    page_title: 'Example Domain',\n    event_name: 'page_view',\n    'x-ga-tfd':\
  \ 5784,\n    ip_override: '2804:14d:c096:8dd6:311c:8c00:e6c:e33',\n    user_agent:\n\
  \      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML,\
  \ like Gecko) Chrome/136.0.0.0 Safari/537.36',\n    value: 123.45,\n    currency:\
  \ 'BRL',\n    user_id: 'userId',\n    user_data: {\n      email: { 0: 'userEmail',\
  \ 1: 'test2@example.net' },\n      phone_number: '+55 (19) 99999-9999'\n    },\n\
  \    coupon: 'coupon',\n    transaction_id: 'transaction_id',\n    search_term:\
  \ 'search_term',\n    items: [\n      {\n        item_id: 'SKU_12345',\n       \
  \ item_name: 'Stan and Friends Tee',\n        affiliation: 'Google Merchandise Store',\n\
  \        coupon: 'SUMMER_FUN',\n        discount: 2.22,\n        index: 0,\n   \
  \     item_brand: 'Google',\n        item_category: 'Apparel|iajsdiajsd|oasodiasd',\n\
  \        item_list_id: 'related_products',\n        item_list_name: 'Related Products',\n\
  \        item_variant: 'green',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n\
  \        price: 10.01,\n        quantity: 3,\n        item_group_id: 'abc'\n   \
  \   },\n      {\n        item_id: 'SKU_12346',\n        item_name: \"Google Grey\
  \ Women's (Tee)\",\n        affiliation: 'Google Merchandise Store',\n        coupon:\
  \ 'SUMMER_FUN',\n        discount: 3.33,\n        index: 1,\n        item_brand:\
  \ 'Google',\n        item_category: 'Apparel|iajsdiajsd|oasodiasd',\n        item_list_id:\
  \ 'related_products',\n        item_list_name: 'Related Products',\n        item_variant:\
  \ 'gray',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n        price: 21.01,\n\
  \        promotion_id: 'P_12345',\n        promotion_name: 'Summer Sale',\n    \
  \    quantity: 2,\n        item_group_id: 'xyz'\n      }\n    ]\n  }, objToBeMerged\
  \ || {}));\n};\n\nconst expectedBigQuerySettings = {\n  logBigQueryProjectId: 'logBigQueryProjectId',\n\
  \  logBigQueryDatasetId: 'logBigQueryDatasetId',\n  logBigQueryTableId: 'logBigQueryTableId'\n\
  };\n\nconst requiredConsoleKeys = ['Type', 'TraceId', 'Name'];\nconst requiredBqKeys\
  \ = ['timestamp', 'type', 'trace_id', 'tag_name'];\nconst expectedBqOptions = {\
  \ ignoreUnknownValues: true };\n\nconst mockData = {\n  useOptimisticScenario: false,\n\
  \  adStorageConsent: 'optional',\n  logBigQueryProjectId: expectedBigQuerySettings.logBigQueryProjectId,\n\
  \  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n  logBigQueryTableId:\
  \ expectedBigQuerySettings.logBigQueryTableId\n};\n\nconst setAllMockDataByEventType\
  \ = (type, objToBeMerged) => {\n  const base = {\n    eventTypeSetupMethod: 'standard',\n\
  \n    uetTagId: '123456789',\n    authToken: 'test',\n    consent: true,\n    enableClientSideIdSync:\
  \ true,\n    accountCustomerId: '123456',\n    useOptimisticScenario: false,\n \
  \   \n    setClickIdCookie: true,\n    clickIdCookieDomain: 'auto',\n    clickIdCookieHttpOnly:\
  \ false,\n    clickIdCookieExpiration: '90',\n    setAnonymousIdCookie: true,\n\
  \    anonymousIdCookieDomain: 'auto',\n    anonymousIdCookieHttpOnly: false,\n \
  \   anonymousIdCookieExpiration: '390',\n  \n    autoMapServerEventDataParameters:\
  \ true,\n    serverEventDataList: [\n      { name: 'eventId', value: 'test' },\n\
  \      { name: 'eventSourceUrl', value: 'test' },\n      { name: 'eventTime', value:\
  \ 123456789 },\n      { name: 'pageLoadId', value: 'test' },\n      { name: 'keywords',\
  \ value: 'test' },\n      { name: 'pageTitle', value: 'test' },\n      { name: 'referrerUrl',\
  \ value: 'test' }\n    ],\n    \n    autoMapUserDataParameters: true,\n    userDataParametersObject:\
  \ {\n      clientIpAddress: 'test'  // Just to check if the merging works.\n   \
  \ },\n    userDataParametersList: [\n      { name: 'anonymousId', value: 'test'\
  \ },\n      { name: 'externalId', value: 'test' },\n      { name: 'msclkid', value:\
  \ 'test' },\n      { name: 'em', value: 'test' },\n      { name: 'ph', value: 'test'\
  \ },\n      { name: 'clientUserAgent', value: 'test' },\n      { name: 'idfa', value:\
  \ 'test' },\n      { name: 'gaid', value: 'test' }\n    ],\n  \n    pageType: 'home',\n\
  \    itemIdKey: '',\n    autoMapEventParameters: true,\n    eventParametersObject:\
  \ {\n      eventCategory: 'test'  // Just to check if the merging works.\n    },\n\
  \    eventParametersList: [\n      { name: 'eventLabel', value: 'test' },\n    \
  \  { name: 'eventValue', value: 'test' },\n      { name: 'searchTerm', value: 'test'\
  \ },\n      { name: 'transactionId', value: 'test' },\n      { name: 'value', value:\
  \ 'test' },\n      { name: 'currency', value: 'test' },\n      { name: 'items',\
  \ value: [{ id: 'id', name: 'name', quantity: 1, price: 123.45 }] },\n      { name:\
  \ 'itemIds', value: ['foo', 'bar'] },\n      { name: 'ecommTotalValue', value: 'test'\
  \ },\n      { name: 'ecommCategory', value: 'test' },\n      { name: 'hotelData.totalPrice',\
  \ value: 'test' },\n      { name: 'hotelData.basePrice', value: 'test' },\n    \
  \  { name: 'hotelData.checkinDate', value: 'test' },\n      { name: 'hotelData.checkoutDate',\
  \ value: 'test' },\n      { name: 'hotelData.lengthOfStay', value: 'test' },\n \
  \     { name: 'hotelData.partnerHotelId', value: 'test' },\n      { name: 'hotelData.bookingHref',\
  \ value: 'test' }\n    ],\n  \n    adStorageConsent: 'optional',\n    logType: 'debug',\n\
  \    bigQueryLogType: 'no'\n  };\n  \n  const mockDataByEventType = {\n    pageLoad:\
  \ {\n      eventType: 'pageLoad',\n    },\n    custom: {\n      eventType: 'custom',\n\
  \      customEventEventName: 'test',\n    }\n  };\n  \n  mergeObj(base, objToBeMerged\
  \ || {});\n  mergeObj(mockDataByEventType[type], base);\n  mergeObj(mockData, mockDataByEventType[type]);\n\
  \  return mockData;\n};\n\nconst clickIdCookieNames = {\n  js: '_uetmsclkid',\n\
  \  server: 'uet_msclkid'\n};\nconst anonymousIdCookieNames = {\n  js: '_uetvid',\n\
  \  server: 'uet_vid'\n};\nconst getExpectedCookieOptions = (cookieType) => {\n \
  \ const cookieOptionsByType = {\n    clickId: {\n      domain: mockData.clickIdCookieDomain\
  \ || 'auto',\n      samesite: 'Lax',\n      path: '/',\n      secure: true,\n  \
  \    httpOnly: !!mockData.clickIdCookieHttpOnly,\n      'max-age': 60 * 60 * 24\
  \ * makeInteger(mockData.clickIdCookieExpiration || 90)\n    },\n    anonymousId:{\n\
  \      domain: mockData.anonymousIdCookieDomain || 'auto',\n      samesite: 'Lax',\n\
  \      path: '/',\n      secure: true,\n      httpOnly: !!mockData.anonymousIdCookieHttpOnly,\n\
  \      'max-age': 60 * 60 * 24 * makeInteger(mockData.anonymousIdCookieExpiration\
  \ || 390)\n    }\n  };\n  \n  return cookieOptionsByType[cookieType];\n};\n\nmock('sendHttpRequest',\
  \ (requestUrl, callback, requestOptions, requestBody) => {\n  if (typeof callback\
  \ === 'function') {\n    callback(200);\n  } else {\n    requestBody = requestOptions;\n\
  \    requestOptions = callback;\n    return Promise.create((resolve, reject) =>\
  \ {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nmock('getRequestHeader',\
  \ (header) => {\n  if (header === 'trace-id') return 'expectedTraceId';\n});\n\n\
  mock('getTimestampMillis', 1747945830456);"


___NOTES___

Created on 8/20/2025, 2:02:02 PM

